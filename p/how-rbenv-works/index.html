<!doctype html><html lang=ko-kr><head><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-MVR22VL');</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Ruby 버전 관리자인 rbenv의 동작 원리를 파헤쳐보자."><title>rbenv의 동작 원리</title><link rel=canonical href=https://notes.hphk.io/p/how-rbenv-works/><link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="rbenv의 동작 원리"><meta property="og:description" content="Ruby 버전 관리자인 rbenv의 동작 원리를 파헤쳐보자."><meta property="og:url" content="https://notes.hphk.io/p/how-rbenv-works/"><meta property="og:site_name" content="해피해킹 메모장"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="ruby"><meta property="article:published_time" content="2021-01-28T15:53:00+09:00"><meta property="article:modified_time" content="2021-01-28T15:53:00+09:00"><meta property="og:image" content="https://notes.hphk.io/og-image.png"><meta name=twitter:title content="rbenv의 동작 원리"><meta name=twitter:description content="Ruby 버전 관리자인 rbenv의 동작 원리를 파헤쳐보자."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://notes.hphk.io/og-image.png"><link rel="shortcut icon" href=/favicon.ico><link rel=apple-touch-icon-precomposed href=/favicon-180.png></head><body class="article-page keep-sidebar"><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVR22VL" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><script>(function(){const colorSchemeKey='StackColorScheme';if(!localStorage.getItem(colorSchemeKey)){localStorage.setItem(colorSchemeKey,"auto");}})();</script><script>(function(){const colorSchemeKey='StackColorScheme';const colorSchemeItem=localStorage.getItem(colorSchemeKey);const supportDarkMode=window.matchMedia('(prefers-color-scheme: dark)').matches===true;if(colorSchemeItem=='dark'||colorSchemeItem==='auto'&&supportDarkMode){document.body.dataset.scheme='dark';}else{document.body.dataset.scheme='light';}})();</script><div class="container main-container flex on-phone--column compact"><aside class="sidebar left-sidebar sticky width-auto"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header class=site-info><h1 class=site-name><a href=https://notes.hphk.io><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-box" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><polyline points="12 3 20 7.5 20 16.5 12 21 4 16.5 4 7.5 12 3"/><line x1="12" y1="12" x2="20" y2="7.5"/><line x1="12" y1="12" x2="12" y2="21"/><line x1="12" y1="12" x2="4" y2="7.5"/></svg></a></h1></header><ol class="menu compact" id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg></a></li><li><a href=/archives><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg></a></li><li><a href=/search><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg></a></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="4"/><path d="M3 12h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446 9 9 0 11-8.313-12.454z"/></svg></li></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/tool/ style=background-color:#5c7cfa;color:#fff>Tool</a></header><h2 class=article-title><a href=/p/how-rbenv-works/>rbenv의 동작 원리</a></h2><h3 class=article-subtitle>Ruby 버전 관리자인 rbenv의 동작 원리를 파헤쳐보자.</h3><footer class=article-details-footer><div class=article-time><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--published>2021년 01월 28일</time></div></footer></div></header><nav id=TableOfContents><ul><li><a href=#rbenv-init>rbenv init</a></li><li><a href=#shims>shims</a></li><li><a href=#rbenv-exec>rbenv exec</a></li><li><a href=#rbenv-rehash>rbenv rehash</a></li></ul></nav><section class=article-content><p>rbenv는 설치된 모든 버전의 ruby를 <code>~/.rbenv/versions</code> 디렉토리 아래에 둔다.</p><h2 id=rbenv-init>rbenv init</h2><p><code>rbenv init -</code> 명령어를 실행하면 rbenv의 초기화 스크립트가 출력된다.</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>$ rbenv init -
<span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span><span class=s2>&#34;/Users/zzulu/.rbenv/shims:</span><span class=si>${</span><span class=nv>PATH</span><span class=si>}</span><span class=s2>&#34;</span>
<span class=nb>export</span> <span class=nv>RBENV_SHELL</span><span class=o>=</span>bash
<span class=nb>source</span> <span class=s1>&#39;/usr/local/Cellar/rbenv/1.1.1/libexec/../completions/rbenv.bash&#39;</span>
<span class=nb>command</span> rbenv rehash 2&gt;/dev/null
rbenv<span class=o>()</span> <span class=o>{</span>
  <span class=nb>local</span> <span class=nb>command</span>
  <span class=nv>command</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
  <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$#</span><span class=s2>&#34;</span> -gt <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
    <span class=nb>shift</span>
  <span class=k>fi</span>

  <span class=k>case</span> <span class=s2>&#34;</span><span class=nv>$command</span><span class=s2>&#34;</span> in
  rehash<span class=p>|</span>shell<span class=o>)</span>
    <span class=nb>eval</span> <span class=s2>&#34;</span><span class=k>$(</span>rbenv <span class=s2>&#34;sh-</span><span class=nv>$command</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span><span class=k>)</span><span class=s2>&#34;</span><span class=p>;;</span>
  *<span class=o>)</span>
    <span class=nb>command</span> rbenv <span class=s2>&#34;</span><span class=nv>$command</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span><span class=p>;;</span>
  <span class=k>esac</span>
<span class=o>}</span>
</code></pre></div><p>따라서 <code>eval "$(rbenv init –)"</code> 명령어를 통해서 rbenv의 초기화 스크립트를 실행한다. rbenv를 사용하기 위해서는 초기화가 항상 필요하므로, <code>~/.bash_profile</code>에 아래의 내용을 작성하여 터미널이 실행될 때 마다 rbenv의 초기화가 진행되도록 한다.</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=k>if</span> which rbenv &gt; /dev/null<span class=p>;</span> <span class=k>then</span> <span class=nb>eval</span> <span class=s2>&#34;</span><span class=k>$(</span>rbenv init -<span class=k>)</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>fi</span>
</code></pre></div><h2 id=shims>shims</h2><p>shim에 대한 위키피디아의 정의는 다음과 같다.</p><blockquote><p>In computer programming, a shim is a small library that transparently intercepts API calls and changes the arguments passed, handles the operation itself, or redirects the operation elsewhere.</p></blockquote><p>rbenv는 <code>~/.rbenv/shims</code> 디렉토리가 존재하며, 환경변수 <code>PATH</code>의 제일 앞에 이 경로를 추가함으로써 터미널에서 실행되는 명령어가 rbenv의 관리하에 있는 ruby 명령어일 경우 rbenv가 intercept 할 수 있도록 한다.
따라서 <code>ruby -v</code> 명령어를 실행하게 되면, <code>~/.rbenv/shims</code> 디렉토리에서 shim script인 <code>ruby</code>를 찾고, 실행하게 된다.</p><p><code>~/.rbenv/shims</code> 디렉토리에 있는 실행 파일들의 내용을 보면 모두가 아래와 같은 동일한 쉘 스크립트 코드를 가지고 있다. <code>~/.rbenv/shims/rails</code>든 <code>~/.rbenv/shims/bundler</code>든 모두 같은 코드를 가지고 있다.</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=cp>#!/usr/bin/env bash
</span><span class=cp></span><span class=nb>set</span> -e
<span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$RBENV_DEBUG</span><span class=s2>&#34;</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=nb>set</span> -x

<span class=nv>program</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>0</span><span class=p>##*/</span><span class=si>}</span><span class=s2>&#34;</span>
<span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$program</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=s2>&#34;ruby&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
  <span class=k>for</span> arg<span class=p>;</span> <span class=k>do</span>
    <span class=k>case</span> <span class=s2>&#34;</span><span class=nv>$arg</span><span class=s2>&#34;</span> in
    -e* <span class=p>|</span> -- <span class=o>)</span> <span class=nb>break</span> <span class=p>;;</span>
    */* <span class=o>)</span>
      <span class=k>if</span> <span class=o>[</span> -f <span class=s2>&#34;</span><span class=nv>$arg</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        <span class=nb>export</span> <span class=nv>RBENV_DIR</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>arg</span><span class=p>%/*</span><span class=si>}</span><span class=s2>&#34;</span>
        <span class=nb>break</span>
      <span class=k>fi</span>  
      <span class=p>;;</span>  
    <span class=k>esac</span>
  <span class=k>done</span>
<span class=k>fi</span>

<span class=nb>export</span> <span class=nv>RBENV_ROOT</span><span class=o>=</span><span class=s2>&#34;/Users/zzulu/.rbenv&#34;</span>
<span class=nb>exec</span> <span class=s2>&#34;/usr/local/Cellar/rbenv/1.1.1/libexec/rbenv&#34;</span> <span class=nb>exec</span> <span class=s2>&#34;</span><span class=nv>$program</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span>
</code></pre></div><p>shim 파일 자체로는 많은 일을 하지 않는다. 환경 변수 <code>RBENV_DIR</code>와 <code>RBENV_ROOT</code>를 설정하고, <code>/usr/local/Cellar/rbenv/1.0.0/libexec/rbenv exec [original-command] [original-args]</code> 명령어를 실행한다.
따라서 <code>rails s</code>를 명령어를 입력하면 <code>~/.rbenv/shims/rails</code>가 실행이 되는 것이고, 실제로는 <code>rbenv exec rails s</code>가 실행되는 것이다.</p><h2 id=rbenv-exec>rbenv exec</h2><p><code>rbenv exec</code>는 현재 사용중인 ruby 버전의 bin 디렉토리가 제일 앞에 오도록 환경 변수 <code>PATH</code>를 설정하여 script 파일을 실행하도록 한다.</p><p><code>rbenv exec rails s</code>를 실행하게 되면 다음과 같은 과정을 거쳐 실행된다.</p><ol><li>어떤 버전의 ruby를 사용할 지 찾는다. <code>rbenv version-name</code> 명령어를 입력하면 현재 위치에서 사용하게 되는 ruby 버전을 보여주는데 이 버전을 사용한다. (<a class=link href=/2018/06/21/Detecting-Ruby-Version-In-rbenv.html>rbenv가 ruby 버전을 찾는 순서</a>)</li></ol><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=nv>RBENV_VERSION</span><span class=o>=</span>2.4.1
</code></pre></div><ol start=2><li>어떤 명령어를 실행할지 exec script의 첫 argument에서 찾는다. <code>rbenv exec rails s</code>를 실행했으므로 지금 상황에서는 <code>rails</code> 명령어를 나타낸다.</li></ol><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=nv>RBENV_COMMAND</span><span class=o>=</span>rails
</code></pre></div><ol start=3><li><code>rbenv which</code> 명령어 실행하여 실행될 명령어가 있는 path를 찾는다. <code>rbenv which rails</code> 명령어를 입력하면 path를 보여주는데 이 path를 사용한다.</li></ol><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>$ rbenv which rails
/Users/zzulu/.rbenv/versions/2.4.1/bin/rails
</code></pre></div><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=nv>RBENV_COMMAND_PATH</span><span class=o>=</span>/Users/zzulu/.rbenv/versions/2.4.1/bin/rails
</code></pre></div><ol start=4><li><code>RBENV_COMMAND_PATH</code>로부터 <code>RBENV_BIN_PATH</code>를 생성하여 환경 변수 <code>PATH</code>의 앞에 붙인다.</li></ol><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=nv>RBENV_BIN_PATH</span><span class=o>=</span>/Users/shot/.rbenv/versions/2.4.1/bin
<span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>RBENV_BIN_PATH</span><span class=si>}</span><span class=s2>:</span><span class=si>${</span><span class=nv>PATH</span><span class=si>}</span><span class=s2>&#34;</span>
</code></pre></div><ol start=5><li>최종적으로 원본 명령어가 실행된다. 시스템은 shim이 아닌 원래의 binary를 찾아 실행한다.</li></ol><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>rails s
</code></pre></div><p>요약하자면 <code>rbenv exec rails s</code> 명령어를 실행하면, rbenv exec가 명령어를 <code>PATH="~/.rbenv/versions/2.4.1/bin:$PATH" rails s</code>로 변경하여 실행하게 된다.</p><h2 id=rbenv-rehash>rbenv rehash</h2><p><code>rbenv rehash</code>는 <code>~/.rbenv/shims</code> 디렉토리에 shim script를 만들어주는 명령어이다.</p><p>이 명령어의 실행결과로 <code>~/.rbenv/versions/[ruby-version]/bin</code> 디렉토리의 각 파일명과 동일한 쉘 스크립트 파일이 <code>~/.rbenv/shims</code> 디렉토리에 생성된다.</p><p>새로운 젬을 추가(<code>gem install rails</code>) 또는 삭제(<code>gem uninstall rails</code>)한 후에는 <code>rbenv rehash</code> 명령어가 실행되어 현재의 ruby 버전의 실행 파일들(<code>~/.rbenv/versions/[current-version]/bin/</code> 디렉토리 안의 스크립트들)의 이름과 동일한 shim script 파일들을 <code>~/.rbenv/shims</code> 디렉토리에 생성한다. (오래된 버전의 rbenv는 자동으로 이 작업을 해주지 않아 따로 plugin이 존재했었다. 그러나 지금은 자동으로 해준다.)</p><p>shim들이 생성되는 상세한 과정은 다음과 같다.</p><ol><li><p><code>~/.rbenv/shims</code> 디렉토리가 존재하는지 확인한다. 만약에 디렉토리가 없다면 생성한다.</p></li><li><p>shim prototype 파일인 <code>~/.rbenv/shims/.rbenv-shim</code>이 존재하는지 확인한다. 만약에 존재한다면 다른 곳에서 rehash가 진행되고 있다는 의미이므로 현재 진행중인 rehash를 종료한다.</p></li><li><p><code>.rbenv-shim</code> 파일이 없다면 생성하여, 다른 rehash 작업이 방해하지 못하도록 한다. 그리고는 위에서 보았던 shim script의 내용을 prototype 파일에 작성한다.</p></li><li><p>설치된 ruby 버전의 모든 bin 디렉토리를 탐색하여 해당 디렉토리에 존재하는 스크립트의 이름과 동일한 이름의 shim script를 <code>~/.rbenv/shims</code> 디렉토리에 생성하고, prototype 파일에 작성된 내용을 shim script에 복사한다. 모든 shim script는 같은 내용으로 작성된다.</p></li><li><p>마지막으로 prototype 파일을 삭제한다.</p></li></ol></section><footer class=article-footer><section class=article-tags><a href=/tags/ruby/>ruby</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><div class=utterances-container><script src=https://utteranc.es/client.js repo=hphkinc/notes issue-term=pathname theme=preferred-color-scheme crossorigin=anonymous async></script></div><style>.utterances{max-width:unset}.utterances-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:calc(var(--card-padding)/2) var(--card-padding)}</style><script>window.addEventListener('onColorSchemeChange',(e)=>{let utterances=document.querySelector('.utterances iframe');if(utterances){utterances.contentWindow.postMessage({type:'set-theme',theme:`github-${e.detail}`},'https://utteranc.es');}})</script><footer class=site-footer><section class=copyright>&copy;
2021 <a href=https://hphk.kr target=_blank rel=noopener>Happy Hacking, Inc.</a></section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=2.0.1>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const customFont=document.createElement('link');customFont.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";customFont.type="text/css";customFont.rel="stylesheet";document.head.appendChild(customFont);}());</script></body></html>